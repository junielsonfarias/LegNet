// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String    @id @default(cuid())
  name                 String?
  email                String    @unique
  emailVerified        DateTime?
  image                String?
  password             String?
  role                 UserRole  @default(USER)
  parlamentarId        String?   @unique // Relacionamento com Parlamentar (se for parlamentar)
  ativo                Boolean   @default(true)
  twoFactorEnabled     Boolean   @default(false)
  twoFactorSecret      String?   @db.Text
  twoFactorBackupCodes String?   @db.Text
  lastTwoFactorAt      DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  accounts    Account[]
  sessions    Session[]
  parlamentar Parlamentar? @relation(fields: [parlamentarId], references: [id])
  favoritos   Favorito[]

  @@index([role, ativo])
  @@index([createdAt])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

enum UserRole {
  ADMIN
  EDITOR
  USER
  PARLAMENTAR
  OPERADOR
  SECRETARIA
  AUXILIAR_LEGISLATIVO
}

// =============================================================================
// Modelo de Tenant (Multi-Tenant)
// =============================================================================

model Tenant {
  id          String       @id @default(cuid())
  slug        String       @unique // Identificador único (ex: "santarem", "mojui-dos-campos")
  nome        String // Nome da Câmara Municipal
  sigla       String? // Sigla (ex: "CMS", "CMM")
  cnpj        String?
  dominio     String?      @unique // Domínio customizado (ex: "camara.santarem.pa.gov.br")
  subdominio  String?      @unique // Subdomínio (ex: "santarem" para santarem.camaras.gov.br)
  ativo       Boolean      @default(true)
  plano       PlanoTenant  @default(BASICO)
  // Configurações visuais
  logoUrl     String?
  faviconUrl  String?
  corPrimaria String?      @default("#1e40af") // Azul padrão
  corSecundaria String?    @default("#3b82f6")
  // Localização
  cidade      String?
  estado      String?
  // Configurações
  timezone    String       @default("America/Sao_Paulo")
  idioma      String       @default("pt-BR")
  // Limites do plano
  maxUsuarios Int          @default(10)
  maxParlamentares Int     @default(20)
  maxArmazenamentoMb Int   @default(1024) // 1GB padrão
  // Metadados
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  expiraEm    DateTime? // Data de expiração do plano

  // Relacionamento com configuração institucional detalhada
  configuracao ConfiguracaoInstitucional?

  // Relacionamento com configurações de quorum
  configuracoesQuorum ConfiguracaoQuorum[]

  // Relacionamento com favoritos
  favoritos Favorito[]

  @@index([ativo])
  @@index([dominio])
  @@index([subdominio])
  @@index([slug])
  @@map("tenants")
}

enum PlanoTenant {
  BASICO // Funcionalidades básicas
  PROFISSIONAL // Funcionalidades avançadas
  ENTERPRISE // Todas as funcionalidades + suporte prioritário
}

model ConfiguracaoInstitucional {
  id                 String   @id @default(cuid())
  slug               String   @unique
  nomeCasa           String
  // Relacionamento com Tenant
  tenantId           String?  @unique
  tenant             Tenant?  @relation(fields: [tenantId], references: [id])
  sigla              String?
  cnpj               String?
  enderecoLogradouro String?
  enderecoNumero     String?
  enderecoBairro     String?
  enderecoCidade     String?
  enderecoEstado     String?
  enderecoCep        String?
  telefone           String?
  email              String?
  site               String?
  logoUrl            String?
  tema               String?  @default("claro")
  timezone           String?  @default("America/Sao_Paulo")
  descricao          String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("configuracoes_institucionais")
}

// Modelos específicos da Câmara

model Parlamentar {
  id          String           @id @default(cuid())
  nome        String
  apelido     String?
  email       String?
  telefone    String?
  partido     String? // Partido atual (mantido para compatibilidade)
  biografia   String?          @db.Text
  foto        String?
  gabinete    String? // Numero/identificacao do gabinete do parlamentar
  cargo       CargoParlamentar @default(VEREADOR)
  legislatura String // Legislatura atual (mantido para compatibilidade)
  ativo       Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relacionamentos
  proposicoes            Proposicao[]
  presencas              PresencaSessao[]
  comissoes              MembroComissao[]
  votacoes               Votacao[]
  mandatos               Mandato[]
  filiacoes              Filiacao[]
  mesasDiretora          MembroMesaDiretora[]
  mesasSessao            MembroMesaSessao[]     // Participações em mesas de sessão
  historicoParticipacoes HistoricoParticipacao[]
  usuario                User? // Relacionamento com User (se tiver acesso ao sistema)
  Tramitacao             Tramitacao[]
  Publicacao             Publicacao[]
  pareceresRelator       Parecer[]              @relation("ParecerRelator")
  votosParecerComissao   VotoParecerComissao[]  @relation("VotoParecerComissao")
  emendasAutor           Emenda[]               @relation("EmendaAutor")
  emendasParecerRelator  Emenda[]               @relation("EmendaParecerRelator")
  votosEmenda            VotoEmenda[]
  pautaItensRelator      PautaItem[]            @relation("PautaItemRelator")
  autorEntidade          Autor?                 @relation("AutorParlamentar") // Vínculo com sistema de autores
  oradoresSessao         OradorSessao[]         // Inscrições como orador em sessões
  presencasOrdemDia      PresencaOrdemDia[]     // Presenças na ordem do dia

  @@index([ativo, cargo])
  @@index([partido])
  @@index([nome])
  @@map("parlamentares")
}

enum CargoParlamentar {
  PRESIDENTE
  VICE_PRESIDENTE
  PRIMEIRO_SECRETARIO
  SEGUNDO_SECRETARIO
  VEREADOR
}

model Sessao {
  id            String       @id @default(cuid())
  numero        Int
  tipo          TipoSessao
  data          DateTime
  horario       String? // Hora da sessão (ex: "14:00")
  local         String? // Local da sessão
  status        StatusSessao @default(AGENDADA)
  descricao     String?      @db.Text
  ata           String?      @db.Text
  finalizada    Boolean      @default(false) // Indica se é uma sessão já finalizada (para inclusão de dados pretéritos)
  legislaturaId String? // Relacionamento com Legislatura
  periodoId     String? // Relacionamento com PeriodoLegislatura
  tempoInicio   DateTime?    // Data/hora real em que a sessão foi iniciada (para cronômetro)

  // === CAMPOS DE MÍDIA (SAPL) ===
  urlAudio       String?     // Link do áudio da sessão (YouTube, etc)
  urlVideo       String?     // Link do vídeo da sessão
  urlTransmissao String?     // Link da transmissão ao vivo
  arquivoPauta   String?     // URL do PDF da pauta publicada
  arquivoAta     String?     // URL do PDF da ata aprovada
  painelAberto   Boolean     @default(false) // Se o painel eletrônico está aberto para votação
  temaSolene     String?     @db.Text // Tema da sessão (para sessões solenes)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relacionamentos
  legislatura         Legislatura?        @relation(fields: [legislaturaId], references: [id])
  periodo             PeriodoLegislatura? @relation(fields: [periodoId], references: [id])
  presencas           PresencaSessao[]
  proposicoes         Proposicao[]        @relation("ProposicaoApresentacao") // Proposições APRESENTADAS nesta sessão
  proposicoesVotadas  Proposicao[]        @relation("ProposicaoVotacao")      // Proposições VOTADAS nesta sessão
  pautaSessao         PautaSessao?
  emendasVotadas      Emenda[]            @relation("EmendaVotacao")          // Emendas VOTADAS nesta sessão
  mesaSessao          MesaSessao?         // Mesa que presidiu esta sessão específica
  oradores            OradorSessao[]      // Oradores inscritos na sessão
  expedientes         ExpedienteSessao[]  // Conteúdo dos expedientes
  presencasOrdemDia   PresencaOrdemDia[]  // Presença específica para ordem do dia

  @@index([status, data])
  @@index([tipo, status])
  @@index([legislaturaId, data])
  @@index([data])
  @@map("sessoes")
}

// Mesa da Sessão - Composição da mesa que presidiu uma sessão específica
// Permite registrar substituições temporárias quando um membro da Mesa Diretora está ausente
model MesaSessao {
  id            String   @id @default(cuid())
  sessaoId      String   @unique
  observacoes   String?  @db.Text // Observações sobre a composição (ex: "Vice assumiu por ausência do presidente")
  criadoPor     String?  // User.id que criou/atualizou
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relacionamentos
  sessao  Sessao             @relation(fields: [sessaoId], references: [id], onDelete: Cascade)
  membros MembroMesaSessao[]

  @@map("mesas_sessao")
}

// Membros que compõem a Mesa de uma Sessão específica
model MembroMesaSessao {
  id           String  @id @default(cuid())
  mesaSessaoId String
  parlamentarId String
  cargo        String  // "PRESIDENTE", "VICE_PRESIDENTE", "PRIMEIRO_SECRETARIO", "SEGUNDO_SECRETARIO"
  titular      Boolean @default(true) // Se é o titular do cargo ou substituto
  observacoes  String? @db.Text // Motivo da substituição, se aplicável
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  mesaSessao  MesaSessao  @relation(fields: [mesaSessaoId], references: [id], onDelete: Cascade)
  parlamentar Parlamentar @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)

  @@unique([mesaSessaoId, cargo]) // Apenas um parlamentar por cargo na mesa da sessão
  @@map("membros_mesa_sessao")
}

// =============================================================================
// ORADORES DA SESSÃO (SAPL)
// =============================================================================

// Oradores inscritos para falar na sessão
model OradorSessao {
  id            String        @id @default(cuid())
  sessaoId      String
  parlamentarId String
  tipo          TipoOrador    // Tipo de inscrição
  ordem         Int           // Ordem de inscrição/fala
  tempoLimite   Int?          // Tempo limite em minutos
  tempoUsado    Int?          // Tempo utilizado em minutos
  assunto       String?       @db.Text // Assunto do pronunciamento
  status        StatusOrador  @default(INSCRITO)
  iniciadoEm    DateTime?     // Quando começou a falar
  finalizadoEm  DateTime?     // Quando terminou
  observacoes   String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  sessao      Sessao      @relation(fields: [sessaoId], references: [id], onDelete: Cascade)
  parlamentar Parlamentar @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)

  @@index([sessaoId, tipo, ordem])
  @@index([parlamentarId])
  @@map("oradores_sessao")
}

enum TipoOrador {
  PEQUENO_EXPEDIENTE    // Pequeno expediente (tempo menor)
  GRANDE_EXPEDIENTE     // Grande expediente (tempo maior)
  LIDERANCA             // Pronunciamento de líder de bancada
  ORDEM_DO_DIA          // Durante discussão da ordem do dia
  EXPLICACAO_PESSOAL    // Explicação pessoal
  APARTE                // Aparte durante discurso de outro
  TRIBUNA_LIVRE         // Tribuna livre/popular
  COMUNICACAO           // Comunicação breve
}

enum StatusOrador {
  INSCRITO              // Inscrito, aguardando vez
  FALANDO               // Em uso da palavra
  CONCLUIDO             // Terminou o pronunciamento
  DESISTIU              // Desistiu da inscrição
  TEMPO_ESGOTADO        // Tempo esgotado
}

// =============================================================================
// TIPOS DE EXPEDIENTE (SAPL)
// =============================================================================

// Tipos de expediente configuráveis
model TipoExpediente {
  id          String   @id @default(cuid())
  nome        String   // Ex: "Pequeno Expediente", "Grande Expediente"
  descricao   String?  @db.Text
  ordem       Int      @default(0) // Ordem de exibição
  tempoMaximo Int?     // Tempo máximo em minutos (opcional)
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  expedientes ExpedienteSessao[]

  @@index([ordem])
  @@map("tipos_expediente")
}

// Conteúdo do expediente por sessão
model ExpedienteSessao {
  id               String   @id @default(cuid())
  sessaoId         String
  tipoExpedienteId String
  conteudo         String   @db.Text // Texto livre do expediente
  ordem            Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  sessao         Sessao         @relation(fields: [sessaoId], references: [id], onDelete: Cascade)
  tipoExpediente TipoExpediente @relation(fields: [tipoExpedienteId], references: [id], onDelete: Cascade)

  @@unique([sessaoId, tipoExpedienteId])
  @@index([sessaoId])
  @@map("expedientes_sessao")
}

// =============================================================================
// PRESENÇA NA ORDEM DO DIA (SAPL)
// =============================================================================

// Presença específica para votação na ordem do dia
// Pode diferir da presença geral da sessão (parlamentar pode sair e voltar)
model PresencaOrdemDia {
  id            String   @id @default(cuid())
  sessaoId      String
  parlamentarId String
  presente      Boolean  @default(true)
  registradoEm  DateTime @default(now())
  observacoes   String?  @db.Text

  sessao      Sessao      @relation(fields: [sessaoId], references: [id], onDelete: Cascade)
  parlamentar Parlamentar @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)

  @@unique([sessaoId, parlamentarId])
  @@index([sessaoId, presente])
  @@map("presencas_ordem_dia")
}

enum TipoSessao {
  ORDINARIA
  EXTRAORDINARIA
  SOLENE
  ESPECIAL
}

enum StatusSessao {
  AGENDADA
  EM_ANDAMENTO
  CONCLUIDA
  CANCELADA
}

enum PautaStatus {
  RASCUNHO
  APROVADA
  EM_ANDAMENTO
  CONCLUIDA
}

enum PautaSecao {
  EXPEDIENTE
  ORDEM_DO_DIA
  COMUNICACOES
  HONRAS
  OUTROS
}

enum PautaItemStatus {
  PENDENTE
  EM_DISCUSSAO
  EM_VOTACAO
  APROVADO
  REJEITADO
  RETIRADO
  ADIADO
  CONCLUIDO
  VISTA             // Pedido de vista - matéria retirada para análise
}

enum TipoVotacao {
  NOMINAL           // Votação nominal - votos individuais são registrados
  SECRETA           // Votação secreta - apenas totais são registrados
  SIMBOLICA         // Votação simbólica - mão levantada, sem registro individual
  LEITURA           // Apenas leitura, sem votação efetiva
}

model ApiToken {
  id            String                  @id @default(cuid())
  nome          String
  descricao     String?
  hashedToken   String                  @unique
  permissoes    String[]
  ativo         Boolean                 @default(true)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  lastUsedAt    DateTime?
  lastUsedIp    String?
  lastUsedAgent String?
  notificacoes  NotificacaoMulticanal[]

  @@unique([nome])
  @@map("api_tokens")
}

model NotificacaoMulticanal {
  id           String   @id @default(cuid())
  tokenId      String?
  canal        String
  destinatario String
  assunto      String?
  mensagem     String   @db.Text
  metadata     Json?
  status       String   @default("pendente")
  tentativas   Int      @default(0)
  erro         String?
  integration  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  token ApiToken? @relation(fields: [tokenId], references: [id])

  @@map("notificacoes_multicanal")
}

model SessaoTemplate {
  id                String     @id @default(cuid())
  nome              String
  descricao         String?
  tipo              TipoSessao
  ativo             Boolean    @default(true)
  duracaoEstimativa Int?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  itens TemplateItem[]

  @@unique([nome, tipo])
  @@map("sessao_templates")
}

model TemplateItem {
  id             String          @id @default(cuid())
  templateId     String
  secao          PautaSecao
  ordem          Int
  titulo         String
  descricao      String?         @db.Text
  tempoEstimado  Int?
  tipoProposicao TipoProposicao?
  obrigatorio    Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  template SessaoTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, secao, ordem])
  @@map("template_itens")
}

model PresencaSessao {
  id            String   @id @default(cuid())
  sessaoId      String
  parlamentarId String
  presente      Boolean  @default(false)
  justificativa String?
  createdAt     DateTime @default(now())

  sessao      Sessao      @relation(fields: [sessaoId], references: [id], onDelete: Cascade)
  parlamentar Parlamentar @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)

  @@unique([sessaoId, parlamentarId])
  @@map("presencas_sessao")
}

model Proposicao {
  id               String            @id @default(cuid())
  slug             String?           @unique // URL amigável: pl-0022-2025
  numero           String
  ano              Int
  tipo             TipoProposicao
  titulo           String
  ementa           String            @db.Text
  texto            String?           @db.Text
  urlDocumento     String?           // URL externa do documento (Google Drive, etc)
  status           StatusProposicao  @default(APRESENTADA)
  dataApresentacao DateTime
  dataVotacao      DateTime?
  resultado        ResultadoVotacao?
  sessaoId         String?           // Sessão onde foi APRESENTADA/LIDA
  sessaoVotacaoId  String?           // Sessão onde foi VOTADA
  dataLeitura      DateTime?         // Data/hora em que foi lida em plenário

  // Autoria - dois sistemas (migração gradual)
  autorId          String?           // LEGADO: Parlamentar autor (opcional para compatibilidade)
  autorEntidadeId  String?           // NOVO: Autor do sistema de autores (Parlamentar, Executivo, Comissão, etc.)

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relacionamentos
  sessao        Sessao?      @relation("ProposicaoApresentacao", fields: [sessaoId], references: [id])
  sessaoVotacao Sessao?      @relation("ProposicaoVotacao", fields: [sessaoVotacaoId], references: [id])
  autor         Parlamentar? @relation(fields: [autorId], references: [id]) // LEGADO
  autorEntidade Autor?       @relation("ProposicaoAutorEntidade", fields: [autorEntidadeId], references: [id]) // NOVO
  votacoes      Votacao[]
  pautaItens    PautaItem[]
  tramitacoes   Tramitacao[]
  pareceres     Parecer[]    // Pareceres das comissões sobre esta proposição
  pautasReuniaoComissao PautaReuniaoComissao[] // Itens de pauta de reunioes de comissao
  emendas       Emenda[]     // Emendas apresentadas a esta proposicao

  @@unique([tipo, numero, ano], name: "tipo_numero_ano")
  @@index([status, dataApresentacao])
  @@index([tipo, status])
  @@index([autorId, ano])
  @@index([autorEntidadeId])
  @@index([ano, tipo])
  @@index([dataApresentacao])
  @@index([sessaoVotacaoId])
  @@map("proposicoes")
}

enum TipoProposicao {
  PROJETO_LEI
  PROJETO_RESOLUCAO
  PROJETO_DECRETO
  INDICACAO
  REQUERIMENTO
  MOCAO
  VOTO_PESAR
  VOTO_APLAUSO
}

// Configurações de tipos de proposição (gerenciável pelo admin)
model TipoProposicaoConfig {
  id              String          @id @default(cuid())
  codigo          TipoProposicao  @unique  // Vincula ao enum
  nome            String                    // Nome completo (ex: "Projeto de Lei")
  sigla           String                    // Sigla (ex: "PL")
  descricao       String?         @db.Text  // Descrição do tipo
  prazoLimite     Int?                      // Prazo limite em dias para tramitação
  requerVotacao   Boolean         @default(true)   // Se requer votação em plenário
  requerSancao    Boolean         @default(false)  // Se requer sanção do executivo
  numeracaoAnual  Boolean         @default(true)   // Se a numeração reinicia a cada ano
  prefixoNumeracao String?                  // Prefixo personalizado (ex: "PL", "IND")
  ativo           Boolean         @default(true)   // Se está ativo para uso
  ordem           Int             @default(0)      // Ordem de exibição
  corBadge        String?                   // Cor para exibição (hex)
  icone           String?                   // Ícone (nome do lucide icon)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("tipos_proposicao_config")
}

// ============================================================
// SISTEMA DE AUTORES (baseado no SAPL)
// ============================================================

// Tipos de autor - categorias de quem pode ser autor de proposições
model TipoAutor {
  id          String   @id @default(cuid())
  nome        String   @unique // Ex: "Parlamentar", "Poder Executivo", "Comissão"
  descricao   String?  @db.Text
  ativo       Boolean  @default(true)
  ordem       Int      @default(0) // Ordem de exibição
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  autores     Autor[]

  @@index([ativo, ordem])
  @@map("tipos_autor")
}

// Autor - entidade que pode ser autor de proposições
// Pode ser vinculado a Parlamentar, Comissão, ou ser um autor externo
model Autor {
  id              String    @id @default(cuid())
  tipoAutorId     String
  nome            String    // Nome de exibição do autor
  descricao       String?   @db.Text

  // Vinculações opcionais (apenas uma deve ser preenchida)
  parlamentarId   String?   @unique // Se for um parlamentar
  comissaoId      String?   // Se for uma comissão

  // Para autores externos (Poder Executivo, Iniciativa Popular, etc.)
  cargo           String?   // Ex: "Prefeito Municipal", "Presidente da Câmara"
  email           String?
  telefone        String?

  ativo           Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relacionamentos
  tipoAutor       TipoAutor    @relation(fields: [tipoAutorId], references: [id])
  parlamentar     Parlamentar? @relation("AutorParlamentar", fields: [parlamentarId], references: [id])
  comissao        Comissao?    @relation("AutorComissao", fields: [comissaoId], references: [id])
  proposicoes     Proposicao[] @relation("ProposicaoAutorEntidade")

  @@index([tipoAutorId])
  @@index([parlamentarId])
  @@index([comissaoId])
  @@index([ativo])
  @@map("autores")
}

// Protocolo de proposicao - numeracao sequencial separada do numero da proposicao
model ProtocoloProposicao {
  id              String    @id @default(cuid())
  numero          Int       // Numero sequencial do ano
  ano             Int       // Ano do protocolo
  codigo          String    @unique // PROT-00001/2026
  proposicaoId    String    @unique
  dataProtocolo   DateTime  @default(now())
  responsavelId   String?   // Usuario que registrou o protocolo
  observacoes     String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([numero, ano])
  @@index([ano])
  @@index([dataProtocolo])
  @@map("protocolos_proposicao")
}

enum StatusProposicao {
  APRESENTADA
  EM_TRAMITACAO
  AGUARDANDO_PAUTA  // Com pareceres, pronta para inclusão na pauta
  EM_PAUTA          // Incluída na ordem do dia de uma sessão
  EM_DISCUSSAO      // Em discussão no plenário
  EM_VOTACAO        // Em processo de votação
  APROVADA
  REJEITADA
  ARQUIVADA
  VETADA
  SANCIONADA        // Sancionada pelo Executivo
  PROMULGADA        // Promulgada e publicada
}

// Tipo de ação do item na pauta (LEITURA vs VOTAÇÃO)
enum TipoAcaoPauta {
  LEITURA       // Apenas leitura no Expediente (primeira apresentação)
  DISCUSSAO     // Discussão sem votação
  VOTACAO       // Discussão e votação na Ordem do Dia
  COMUNICADO    // Informes e comunicações
  HOMENAGEM     // Votos de pesar, aplauso, moções
}

enum ResultadoVotacao {
  APROVADA
  REJEITADA
  EMPATE
}

model Votacao {
  id            String   @id @default(cuid())
  proposicaoId  String
  parlamentarId String
  voto          TipoVoto
  turno         Int      @default(1) // Turno da votação (1º ou 2º turno)
  sessaoId      String?              // Sessão onde o voto foi registrado
  createdAt     DateTime @default(now())

  proposicao  Proposicao  @relation(fields: [proposicaoId], references: [id], onDelete: Cascade)
  parlamentar Parlamentar @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)

  @@unique([proposicaoId, parlamentarId, turno]) // Permite votos diferentes por turno
  @@index([proposicaoId, turno])
  @@index([sessaoId])
  @@map("votacoes")
}

// =============================================================================
// VOTAÇÃO AGRUPADA - Consolida resultado de votação por turno
// =============================================================================

model VotacaoAgrupada {
  id              String              @id @default(cuid())
  proposicaoId    String
  sessaoId        String
  turno           Int                 @default(1)
  tipoQuorum      TipoQuorum          @default(MAIORIA_SIMPLES)
  tipoVotacao     TipoVotacao         @default(NOMINAL)

  // Contagem de votos
  votosSim        Int                 @default(0)
  votosNao        Int                 @default(0)
  votosAbstencao  Int                 @default(0)
  votosAusente    Int                 @default(0)

  // Quorum e resultado
  totalMembros    Int                 @default(0)
  totalPresentes  Int                 @default(0)
  quorumNecessario Int                @default(0)
  resultado       ResultadoVotacaoAgrupada?

  // Controle de tempo
  iniciadaEm      DateTime?
  finalizadaEm    DateTime?

  // Observações
  observacoes     String?             @db.Text

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([proposicaoId, sessaoId, turno])
  @@index([sessaoId, turno])
  @@index([resultado])
  @@map("votacoes_agrupadas")
}

enum ResultadoVotacaoAgrupada {
  APROVADA
  REJEITADA
  EMPATE
  SEM_QUORUM
  ADIADA
  PREJUDICADA
}

enum TipoVoto {
  SIM
  NAO
  ABSTENCAO
  AUSENTE
}

// =============================================================================
// SISTEMA DE EMENDAS
// =============================================================================

model Emenda {
  id              String          @id @default(cuid())
  proposicaoId    String          // Proposicao que esta sendo emendada

  // Numeracao
  numero          Int             // Numero sequencial da emenda na proposicao

  // Tipo de emenda
  tipo            TipoEmenda

  // Status
  status          StatusEmenda    @default(APRESENTADA)

  // Autor
  autorId         String          // Parlamentar autor da emenda
  coautores       String?         @db.Text  // JSON com IDs dos coautores

  // Referencia ao texto original (onde a emenda incide)
  artigo          String?         // Ex: "Art. 1"
  paragrafo       String?         // Ex: "§ 1º"
  inciso          String?         // Ex: "I"
  alinea          String?         // Ex: "a"
  dispositivo     String?         @db.Text  // Descricao livre do dispositivo

  // Conteudo da emenda
  textoOriginal   String?         @db.Text  // Texto original que sera alterado
  textoNovo       String          @db.Text  // Novo texto proposto
  justificativa   String          @db.Text  // Justificativa da emenda

  // Votacao
  turnoApresentacao   Int         @default(1)  // Turno em que foi apresentada
  sessaoVotacaoId     String?     // Sessao onde foi votada
  dataVotacao         DateTime?
  resultado           ResultadoEmenda?
  votosSim            Int?        // Contagem de votos SIM
  votosNao            Int?        // Contagem de votos NAO
  votosAbstencao      Int?        // Contagem de abstencoes
  prazoEmenda         DateTime?   // Prazo para apresentacao da emenda

  // Parecer
  parecerComissao     String?     // ID da comissao que emitiu parecer
  parecerTipo         TipoParecerEmenda?
  parecerTexto        String?     @db.Text
  parecerData         DateTime?
  parecerRelatorId    String?     // Parlamentar relator do parecer

  // Aglutinacao (quando varias emendas sao unidas)
  aglutinada          Boolean     @default(false)
  emendaAglutinadaId  String?     // ID da emenda resultante da aglutinacao

  // Observacoes
  observacoes         String?     @db.Text

  // Controle
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // Relacionamentos
  proposicao          Proposicao  @relation(fields: [proposicaoId], references: [id], onDelete: Cascade)
  autor               Parlamentar @relation("EmendaAutor", fields: [autorId], references: [id])
  parecerRelator      Parlamentar? @relation("EmendaParecerRelator", fields: [parecerRelatorId], references: [id])
  sessaoVotacao       Sessao?     @relation("EmendaVotacao", fields: [sessaoVotacaoId], references: [id])
  emendaAglutinada    Emenda?     @relation("EmendaAglutinacao", fields: [emendaAglutinadaId], references: [id])
  emendasAglutinadas  Emenda[]    @relation("EmendaAglutinacao")
  votosEmenda         VotoEmenda[]

  @@unique([proposicaoId, numero])
  @@index([proposicaoId])
  @@index([autorId])
  @@index([status])
  @@index([sessaoVotacaoId])
  @@map("emendas")
}

enum TipoEmenda {
  ADITIVA           // Acrescenta texto novo
  MODIFICATIVA      // Altera texto existente
  SUPRESSIVA        // Remove texto existente
  SUBSTITUTIVA      // Substitui integralmente o texto
  EMENDA_DE_REDACAO // Corrige redacao sem alterar conteudo
  AGLUTINATIVA      // Une varias emendas em uma
}

enum StatusEmenda {
  APRESENTADA       // Emenda apresentada
  EM_ANALISE        // Em analise pela comissao
  PARECER_EMITIDO   // Parecer da comissao emitido
  EM_VOTACAO        // Em votacao no plenario
  APROVADA          // Aprovada
  REJEITADA         // Rejeitada
  PREJUDICADA       // Prejudicada por aprovacao de outra
  RETIRADA          // Retirada pelo autor
  INCORPORADA       // Incorporada ao texto (apos aprovacao)
}

enum ResultadoEmenda {
  APROVADA
  REJEITADA
  PREJUDICADA
  RETIRADA
}

enum TipoParecerEmenda {
  FAVORAVEL
  FAVORAVEL_COM_RESSALVAS
  CONTRARIO
  PELA_REJEICAO
  PELA_APROVACAO_PARCIAL
}

// Votos individuais em emendas
model VotoEmenda {
  id            String      @id @default(cuid())
  emendaId      String
  parlamentarId String
  voto          TipoVoto
  sessaoId      String?     // Sessao onde o voto foi registrado
  createdAt     DateTime    @default(now())

  emenda        Emenda      @relation(fields: [emendaId], references: [id], onDelete: Cascade)
  parlamentar   Parlamentar @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)

  @@unique([emendaId, parlamentarId])
  @@index([emendaId])
  @@index([parlamentarId])
  @@map("votos_emenda")
}

model Comissao {
  id        String       @id @default(cuid())
  nome      String
  sigla     String?      // Sigla da comissão (ex: CLJ, CFO)
  descricao String?      @db.Text
  tipo      TipoComissao
  ativa     Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relacionamentos
  membros        MembroComissao[]
  pareceres      Parecer[]    // Pareceres emitidos por esta comissão
  reunioes       ReuniaoComissao[]  // Reunioes da comissao
  autorEntidades Autor[]      @relation("AutorComissao") // Vínculo com sistema de autores

  @@index([tipo, ativa])
  @@index([ativa])
  @@map("comissoes")
}

enum TipoComissao {
  PERMANENTE
  TEMPORARIA
  ESPECIAL
  INQUERITO
}

model MembroComissao {
  id            String        @id @default(cuid())
  comissaoId    String
  parlamentarId String
  cargo         CargoComissao @default(MEMBRO)
  dataInicio    DateTime
  dataFim       DateTime?
  ativo         Boolean       @default(true)
  observacoes   String?       @db.Text
  createdAt     DateTime      @default(now())

  comissao         Comissao    @relation(fields: [comissaoId], references: [id], onDelete: Cascade)
  parlamentar      Parlamentar @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)
  presencasReuniao PresencaReuniaoComissao[]

  @@unique([comissaoId, parlamentarId])
  @@map("membros_comissao")
}

enum CargoComissao {
  PRESIDENTE
  VICE_PRESIDENTE
  RELATOR
  MEMBRO
}

// ==========================================
// REUNIOES DE COMISSAO
// ==========================================

model ReuniaoComissao {
  id            String              @id @default(cuid())
  comissaoId    String

  // Dados da reuniao
  numero        Int                 // Numero sequencial da reuniao no ano
  ano           Int
  tipo          TipoReuniaoComissao @default(ORDINARIA)
  status        StatusReuniaoComissao @default(AGENDADA)

  // Data e local
  data          DateTime
  horaInicio    DateTime?
  horaFim       DateTime?
  local         String?

  // Convocacao
  dataConvocacao    DateTime?
  motivoConvocacao  String?         @db.Text

  // Pauta e ata
  pautaTexto        String?         @db.Text   // Pauta em texto livre (alem dos itens)
  ataTexto          String?         @db.Text   // Ata da reuniao
  ataAprovada       Boolean         @default(false)
  dataAprovacaoAta  DateTime?

  // Quorum
  quorumMinimo      Int             @default(2)  // Minimo de membros para instalacao

  // Observacoes
  observacoes       String?         @db.Text

  // Controle
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  criadoPorId       String?

  // Relacionamentos
  comissao          Comissao        @relation(fields: [comissaoId], references: [id], onDelete: Cascade)
  itens             PautaReuniaoComissao[]
  presencas         PresencaReuniaoComissao[]
  pareceres         Parecer[]       // Pareceres votados nesta reuniao

  @@unique([comissaoId, numero, ano])
  @@index([comissaoId])
  @@index([data])
  @@index([status])
  @@map("reunioes_comissao")
}

enum TipoReuniaoComissao {
  ORDINARIA
  EXTRAORDINARIA
  ESPECIAL
}

enum StatusReuniaoComissao {
  AGENDADA
  CONVOCADA
  EM_ANDAMENTO
  SUSPENSA
  CONCLUIDA
  CANCELADA
}

// Itens da pauta da reuniao de comissao
model PautaReuniaoComissao {
  id            String                    @id @default(cuid())
  reuniaoId     String
  proposicaoId  String?                   // Proposicao em analise (opcional)
  parecerId     String?                   // Parecer a ser votado (opcional)

  // Dados do item
  ordem         Int                       // Ordem na pauta
  titulo        String                    // Titulo/descricao do item
  descricao     String?                   @db.Text
  tipo          TipoItemPautaReuniao      @default(ANALISE_PROPOSICAO)

  // Resultado
  status        StatusItemPautaReuniao    @default(PENDENTE)
  resultado     String?                   // Resultado da deliberacao
  observacoes   String?                   @db.Text

  // Tempo
  tempoEstimado Int?                      // Minutos estimados
  tempoReal     Int?                      // Minutos reais

  // Controle
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt

  // Relacionamentos
  reuniao       ReuniaoComissao           @relation(fields: [reuniaoId], references: [id], onDelete: Cascade)
  proposicao    Proposicao?               @relation(fields: [proposicaoId], references: [id], onDelete: SetNull)

  @@unique([reuniaoId, ordem])
  @@index([reuniaoId])
  @@index([proposicaoId])
  @@map("pauta_reuniao_comissao")
}

enum TipoItemPautaReuniao {
  ANALISE_PROPOSICAO      // Analise de proposicao
  VOTACAO_PARECER         // Votacao de parecer
  DESIGNACAO_RELATOR      // Designar relator
  COMUNICACAO             // Comunicado/informe
  OUTROS                  // Outros assuntos
}

enum StatusItemPautaReuniao {
  PENDENTE
  EM_DISCUSSAO
  EM_VOTACAO
  APROVADO
  REJEITADO
  ADIADO
  RETIRADO
}

// Presenca em reuniao de comissao
model PresencaReuniaoComissao {
  id                String          @id @default(cuid())
  reuniaoId         String
  membroComissaoId  String

  // Status de presenca
  presente          Boolean         @default(false)
  justificativa     String?         // Se ausente, justificativa

  // Horarios
  horaChegada       DateTime?
  horaSaida         DateTime?

  // Controle
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relacionamentos
  reuniao           ReuniaoComissao @relation(fields: [reuniaoId], references: [id], onDelete: Cascade)
  membro            MembroComissao  @relation(fields: [membroComissaoId], references: [id], onDelete: Cascade)

  @@unique([reuniaoId, membroComissaoId])
  @@index([reuniaoId])
  @@map("presenca_reuniao_comissao")
}

enum ParticipacaoTipo {
  MESA_DIRETORA
  COMISSAO
}

model HistoricoParticipacao {
  id             String           @id @default(cuid())
  parlamentarId  String
  tipo           ParticipacaoTipo
  referenciaId   String
  referenciaHash String           @unique
  referenciaNome String?
  cargoId        String?
  cargoNome      String
  legislaturaId  String?
  periodoId      String?
  dataInicio     DateTime
  dataFim        DateTime?
  ativo          Boolean          @default(true)
  observacoes    String?          @db.Text
  origem         String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  parlamentar Parlamentar         @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)
  legislatura Legislatura?        @relation(fields: [legislaturaId], references: [id], onDelete: Cascade)
  periodo     PeriodoLegislatura? @relation(fields: [periodoId], references: [id], onDelete: Cascade)

  @@index([parlamentarId, tipo])
  @@map("historico_participacoes")
}

model Publicacao {
  id            String              @id @default(cuid())
  titulo        String
  descricao     String?             @db.Text
  tipo          TipoPublicacao
  numero        String?
  ano           Int
  data          DateTime
  conteudo      String              @db.Text
  arquivo       String?
  tamanho       String?
  publicada     Boolean             @default(false)
  visualizacoes Int                 @default(0)
  categoriaId   String?
  autorTipo     AutorPublicacaoTipo @default(OUTRO)
  autorNome     String
  autorId       String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  categoria        CategoriaPublicacao? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)
  autorParlamentar Parlamentar?         @relation(fields: [autorId], references: [id], onDelete: SetNull)

  @@index([categoriaId])
  @@index([autorId])
  @@map("publicacoes")
}

model CategoriaPublicacao {
  id        String   @id @default(cuid())
  nome      String
  descricao String?
  cor       String?  @default("#0f172a")
  ativa     Boolean  @default(true)
  ordem     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  publicacoes Publicacao[]

  @@unique([nome])
  @@map("categorias_publicacao")
}

enum TipoPublicacao {
  LEI
  DECRETO
  PORTARIA
  RESOLUCAO
  NOTICIA
  INFORMATIVO
  RELATORIO
  PLANEJAMENTO
  MANUAL
  CODIGO
  OUTRO
}

enum AutorPublicacaoTipo {
  PARLAMENTAR
  COMISSAO
  ORGAO
  OUTRO
}

model Noticia {
  id             String    @id @default(cuid())
  titulo         String
  resumo         String?   @db.Text
  conteudo       String    @db.Text
  imagem         String?
  categoria      String?
  tags           String[]
  publicada      Boolean   @default(false)
  dataPublicacao DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([publicada, dataPublicacao])
  @@index([categoria, publicada])
  @@index([dataPublicacao])
  @@map("noticias")
}

model Legislatura {
  id         String    @id @default(cuid())
  numero     Int
  anoInicio  Int
  anoFim     Int
  dataInicio DateTime? // Data completa de início (dia/mês/ano)
  dataFim    DateTime? // Data completa de fim (dia/mês/ano)
  ativa      Boolean   @default(false)
  descricao  String?   @db.Text
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relacionamentos
  mandatos              Mandato[]
  periodos              PeriodoLegislatura[]
  sessoes               Sessao[]
  HistoricoParticipacao HistoricoParticipacao[]

  @@map("legislaturas")
}

model PeriodoLegislatura {
  id            String    @id @default(cuid())
  legislaturaId String
  numero        Int // 1, 2, 3, 4 (dependendo da quantidade de períodos)
  dataInicio    DateTime
  dataFim       DateTime?
  descricao     String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  legislatura           Legislatura             @relation(fields: [legislaturaId], references: [id], onDelete: Cascade)
  mesasDiretora         MesaDiretora[]
  cargos                CargoMesaDiretora[]
  sessoes               Sessao[]
  HistoricoParticipacao HistoricoParticipacao[]

  @@unique([legislaturaId, numero])
  @@map("periodos_legislatura")
}

model CargoMesaDiretora {
  id          String   @id @default(cuid())
  periodoId   String
  nome        String // Ex: "Presidente", "Vice-Presidente", "1º Secretário"
  ordem       Int // Ordem de precedência
  obrigatorio Boolean  @default(true) // Se o cargo é obrigatório
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  periodo PeriodoLegislatura   @relation(fields: [periodoId], references: [id], onDelete: Cascade)
  membros MembroMesaDiretora[]

  @@unique([periodoId, nome])
  @@map("cargos_mesa_diretora")
}

model MesaDiretora {
  id        String   @id @default(cuid())
  periodoId String
  ativa     Boolean  @default(false)
  descricao String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  periodo PeriodoLegislatura   @relation(fields: [periodoId], references: [id], onDelete: Cascade)
  membros MembroMesaDiretora[]

  @@map("mesas_diretora")
}

model MembroMesaDiretora {
  id             String    @id @default(cuid())
  mesaDiretoraId String
  parlamentarId  String
  cargoId        String
  dataInicio     DateTime
  dataFim        DateTime? // Para casos de substituição/afastamento
  ativo          Boolean   @default(true) // Status atual do membro
  observacoes    String?   @db.Text // Para registrar motivo de afastamento
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  mesaDiretora MesaDiretora      @relation(fields: [mesaDiretoraId], references: [id], onDelete: Cascade)
  parlamentar  Parlamentar       @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)
  cargo        CargoMesaDiretora @relation(fields: [cargoId], references: [id], onDelete: Cascade)

  @@unique([mesaDiretoraId, cargoId, ativo]) // Apenas um membro ativo por cargo na mesa
  @@map("membros_mesa_diretora")
}

model Mandato {
  id            String           @id @default(cuid())
  parlamentarId String
  legislaturaId String
  numeroVotos   Int              @default(0)
  cargo         CargoParlamentar @default(VEREADOR)
  dataInicio    DateTime
  dataFim       DateTime?
  ativo         Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  parlamentar Parlamentar @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)
  legislatura Legislatura @relation(fields: [legislaturaId], references: [id], onDelete: Cascade)

  @@unique([parlamentarId, legislaturaId])
  @@map("mandatos")
}

model Filiacao {
  id            String    @id @default(cuid())
  parlamentarId String
  partido       String
  dataInicio    DateTime
  dataFim       DateTime?
  ativa         Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  parlamentar Parlamentar @relation(fields: [parlamentarId], references: [id], onDelete: Cascade)

  @@map("filiacoes")
}

model PautaSessao {
  id                    String      @id @default(cuid())
  sessaoId              String      @unique
  status                PautaStatus @default(RASCUNHO)
  geradaAutomaticamente Boolean     @default(true)
  observacoes           String?     @db.Text
  tempoTotalEstimado    Int         @default(0)
  tempoTotalReal        Int?
  itemAtualId           String?     @unique
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  sessao    Sessao      @relation(fields: [sessaoId], references: [id], onDelete: Cascade)
  itens     PautaItem[]
  itemAtual PautaItem?  @relation("SessaoItemAtual", fields: [itemAtualId], references: [id])

  @@map("pautas_sessao")
}

model PautaItem {
  id             String          @id @default(cuid())
  pautaId        String
  secao          PautaSecao
  ordem          Int
  titulo         String
  descricao      String?         @db.Text
  proposicaoId   String?
  tempoEstimado  Int?
  tempoReal      Int?
  status         PautaItemStatus @default(PENDENTE)
  tipoAcao       TipoAcaoPauta   @default(VOTACAO)  // Tipo de ação: LEITURA, VOTACAO, etc.
  autor          String?
  observacoes    String?         @db.Text
  tempoAcumulado Int             @default(0)
  iniciadoEm     DateTime?
  finalizadoEm   DateTime?
  tipoVotacao    TipoVotacao     @default(NOMINAL)  // Tipo de votação: nominal ou secreta
  vistaRequestedBy String?                           // ID do parlamentar que pediu vista
  vistaRequestedAt DateTime?                         // Data/hora do pedido de vista
  vistaPrazo     DateTime?                           // Prazo para devolução da matéria

  // === CAMPOS DE TURNO (SAPL) ===
  turnoAtual           Int                @default(1)   // Turno atual (1 ou 2)
  turnoFinal           Int?                             // Número total de turnos necessários (1 ou 2)
  resultadoTurno1      ResultadoVotacaoAgrupada?        // Resultado do 1º turno
  resultadoTurno2      ResultadoVotacaoAgrupada?        // Resultado do 2º turno
  dataVotacaoTurno1    DateTime?                        // Data/hora da votação do 1º turno
  dataVotacaoTurno2    DateTime?                        // Data/hora da votação do 2º turno
  intersticio          Boolean            @default(false) // Se aguarda interstício entre turnos
  dataIntersticio      DateTime?                        // Data em que o interstício foi iniciado
  prazoIntersticio     DateTime?                        // Data limite para votação em 2º turno

  // === CAMPOS DE ETAPA E LEITURA ===
  etapa           Int?              // Sub-etapa: 1 = "1ª Ordem do Dia" (leituras), 2 = "2ª Ordem do Dia" (votações)
  parecerId       String?           // Referência ao parecer da comissão vinculado
  leituraNumero   Int?              // Número da leitura (1ª, 2ª, 3ª leitura)
  relatorId       String?           // Relator designado para o item

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  pauta       PautaSessao  @relation(fields: [pautaId], references: [id], onDelete: Cascade)
  proposicao  Proposicao?  @relation(fields: [proposicaoId], references: [id], onDelete: SetNull)
  sessaoAtual PautaSessao? @relation("SessaoItemAtual")
  destaques   DestaquePautaItem[]
  parecer     Parecer?     @relation(fields: [parecerId], references: [id], onDelete: SetNull)
  relator     Parlamentar? @relation("PautaItemRelator", fields: [relatorId], references: [id], onDelete: SetNull)

  @@index([pautaId, secao, ordem])
  @@index([tipoAcao])
  @@index([turnoAtual])
  @@index([secao, etapa])
  @@index([parecerId])
  @@index([relatorId])
  @@map("pauta_itens")
}

// Destaque para votação em separado de parte de uma proposição
model DestaquePautaItem {
  id              String   @id @default(cuid())
  pautaItemId     String
  titulo          String                              // Ex: "Artigo 3º", "Emenda nº 1"
  descricao       String?  @db.Text
  status          PautaItemStatus @default(PENDENTE)  // Status do destaque
  resultado       String?                              // Resultado da votação do destaque
  votosSim        Int      @default(0)
  votosNao        Int      @default(0)
  votosAbstencao  Int      @default(0)
  tipoVotacao     TipoVotacao @default(NOMINAL)
  solicitadoPor   String?                              // ID do parlamentar que solicitou
  solicitadoEm    DateTime @default(now())
  votadoEm        DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  pautaItem       PautaItem @relation(fields: [pautaItemId], references: [id], onDelete: Cascade)

  @@index([pautaItemId])
  @@map("destaques_pauta_item")
}

model Configuracao {
  id        String   @id @default(cuid())
  chave     String   @unique
  valor     String   @db.Text
  descricao String?
  categoria String   @default("Geral")
  tipo      String   @default("string")
  editavel  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("configuracoes")
}

enum AuditStatus {
  SUCCESS
  FAILURE
}

model AuditLog {
  id           String      @id @default(cuid())
  userId       String?
  userEmail    String?
  userName     String?
  userRole     UserRole?
  action       String
  entity       String
  entityId     String?
  ip           String?
  userAgent    String?
  status       AuditStatus @default(SUCCESS)
  errorMessage String?
  metadata     Json?
  createdAt    DateTime    @default(now())

  @@index([entity, createdAt])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

enum TramitacaoStatus {
  RECEBIDA      // Proposição recebida na unidade, aguardando análise
  EM_ANDAMENTO  // Em análise/tramitação
  CONCLUIDA     // Finalizada na unidade
  CANCELADA     // Cancelada
}

enum TramitacaoResultado {
  APROVADO
  REJEITADO
  APROVADO_COM_EMENDAS
  ARQUIVADO
}

enum TramitacaoUnidadeTipo {
  COMISSAO          // Comissões permanentes e temporárias
  MESA_DIRETORA     // Mesa Diretora
  PLENARIO          // Plenário
  PREFEITURA        // Órgãos do Executivo
  SECRETARIA        // Secretarias internas (ex: Secretaria Geral)
  GABINETE          // Gabinetes (Presidente, Vereadores)
  ARQUIVO           // Setor de Arquivo
  PROTOCOLO         // Setor de Protocolo
  ASSESSORIA        // Assessorias (Jurídica, Comunicação, etc.)
  OUTROS            // Outros órgãos não classificados
}

model TramitacaoTipoProposicao {
  id             String          @id @default(cuid())
  tipoProposicao TipoProposicao?
  nome           String
  sigla          String
  descricao      String?
  ativo          Boolean         @default(true)
  prazoLimite    Int?
  requerVotacao  Boolean         @default(true)
  requerSancao   Boolean         @default(false)
  ordem          Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([tipoProposicao])
  @@map("tramitacao_tipo_proposicoes")
}

model TramitacaoUnidade {
  id        String                @id @default(cuid())
  nome      String
  sigla     String?
  descricao String?
  tipo      TramitacaoUnidadeTipo
  ativo     Boolean               @default(true)
  ordem     Int                   @default(0)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  tramitacoes       Tramitacao[]
  tiposResponsaveis TramitacaoTipo[]       @relation("TramitacaoTipoUnidadeResponsavel")
  regraEtapas       RegraTramitacaoEtapa[]
  fluxoEtapas       FluxoTramitacaoEtapa[]

  @@map("tramitacao_unidades")
}

model TramitacaoTipo {
  id                   String               @id @default(cuid())
  nome                 String
  descricao            String?
  prazoRegimental      Int
  prazoLegal           Int?
  unidadeResponsavelId String?
  requerParecer        Boolean              @default(false)
  permiteRetorno       Boolean              @default(false)
  statusResultado      TramitacaoResultado?
  ativo                Boolean              @default(true)
  ordem                Int                  @default(0)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  unidadeResponsavel TramitacaoUnidade?     @relation("TramitacaoTipoUnidadeResponsavel", fields: [unidadeResponsavelId], references: [id])
  tramitacoes        Tramitacao[]
  etapas             RegraTramitacaoEtapa[]

  @@map("tramitacao_tipos")
}

model Tramitacao {
  id               String               @id @default(cuid())
  proposicaoId     String
  dataEntrada      DateTime
  dataSaida        DateTime?
  status           TramitacaoStatus     @default(EM_ANDAMENTO)
  tipoTramitacaoId String
  unidadeId        String
  observacoes      String?
  parecer          String?
  resultado        TramitacaoResultado?
  responsavelId    String?
  prazoVencimento  DateTime?
  diasVencidos     Int?
  automatica       Boolean              @default(false)
  fluxoEtapaId     String?              // Referencia a etapa do fluxo configurado
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  proposicao     Proposicao              @relation(fields: [proposicaoId], references: [id], onDelete: Cascade)
  responsavel    Parlamentar?            @relation(fields: [responsavelId], references: [id])
  tipoTramitacao TramitacaoTipo          @relation(fields: [tipoTramitacaoId], references: [id])
  unidade        TramitacaoUnidade       @relation(fields: [unidadeId], references: [id])
  fluxoEtapa     FluxoTramitacaoEtapa?   @relation(fields: [fluxoEtapaId], references: [id])
  historicos     TramitacaoHistorico[]
  notificacoes   TramitacaoNotificacao[]

  @@index([proposicaoId])
  @@index([fluxoEtapaId])
  @@map("tramitacoes")
}

model TramitacaoHistorico {
  id              String   @id @default(cuid())
  tramitacaoId    String
  data            DateTime @default(now())
  acao            String
  descricao       String?  @db.Text
  usuarioId       String?
  dadosAnteriores Json?
  dadosNovos      Json?
  ip              String?

  tramitacao Tramitacao @relation(fields: [tramitacaoId], references: [id], onDelete: Cascade)

  @@index([tramitacaoId, data])
  @@map("tramitacoes_historico")
}

model TramitacaoNotificacao {
  id           String    @id @default(cuid())
  tramitacaoId String
  canal        String
  destinatario String
  enviadoEm    DateTime?
  status       String?
  mensagem     String?   @db.Text
  parametros   Json?

  tramitacao Tramitacao @relation(fields: [tramitacaoId], references: [id], onDelete: Cascade)

  @@index([tramitacaoId, canal])
  @@map("tramitacoes_notificacoes")
}

model RegraTramitacao {
  id        String   @id @default(cuid())
  nome      String
  descricao String?
  condicoes Json
  acoes     Json
  excecoes  Json?
  ativo     Boolean  @default(true)
  ordem     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  etapas RegraTramitacaoEtapa[]

  @@map("regras_tramitacao")
}

model RegraTramitacaoEtapa {
  id               String   @id @default(cuid())
  regraId          String
  ordem            Int
  nome             String
  descricao        String?  @db.Text
  tipoTramitacaoId String?
  unidadeId        String?
  notificacoes     Json?
  alertas          Json?
  prazoDias        Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  regra          RegraTramitacao    @relation(fields: [regraId], references: [id], onDelete: Cascade)
  tipoTramitacao TramitacaoTipo?    @relation(fields: [tipoTramitacaoId], references: [id])
  unidade        TramitacaoUnidade? @relation(fields: [unidadeId], references: [id])

  @@index([regraId, ordem])
  @@map("regras_tramitacao_etapas")
}

model ConfiguracaoTramitacao {
  id        String   @id @default(cuid())
  chave     String   @unique
  valor     String   @db.Text
  descricao String?
  categoria String   @default("geral")
  tipo      String   @default("string")
  ativo     Boolean  @default(true)
  editavel  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("configuracoes_tramitacao")
}

// =============================================================================
// SISTEMA DE FLUXOS DE TRAMITACAO CONFIGURAVEIS
// =============================================================================

model FluxoTramitacao {
  id              String          @id @default(cuid())
  tipoProposicao  TipoProposicao  @unique
  nome            String
  descricao       String?         @db.Text
  ativo           Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  etapas          FluxoTramitacaoEtapa[]

  @@map("fluxos_tramitacao")
}

model FluxoTramitacaoEtapa {
  id                String                  @id @default(cuid())
  fluxoId           String
  ordem             Int
  nome              String
  descricao         String?                 @db.Text
  unidadeId         String?
  prazoDiasNormal   Int                     @default(15)
  prazoDiasUrgencia Int?
  requerParecer     Boolean                 @default(false)
  habilitaPauta     Boolean                 @default(false)  // Marca etapa que habilita inclusao na pauta
  ehEtapaFinal      Boolean                 @default(false)
  // Campos para etapas condicionais
  condicional       Boolean                 @default(false)  // Se e etapa condicional (pode ser pulada)
  tipoCondicao      TipoCondicaoEtapa?      // Tipo de condicao para executar a etapa
  condicaoConfig    Json?                   // Configuracao adicional da condicao (campo, operador, valor)
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  fluxo             FluxoTramitacao         @relation(fields: [fluxoId], references: [id], onDelete: Cascade)
  unidade           TramitacaoUnidade?      @relation(fields: [unidadeId], references: [id])
  tramitacoes       Tramitacao[]

  @@unique([fluxoId, ordem])
  @@index([fluxoId])
  @@map("fluxo_tramitacao_etapas")
}

// Tipos de condicao para etapas de fluxo de tramitacao
enum TipoCondicaoEtapa {
  SEMPRE                    // Etapa obrigatoria (padrao)
  IMPACTO_FINANCEIRO        // Executar se proposicao tiver impacto financeiro
  REGIME_URGENCIA           // Executar se proposicao estiver em regime de urgencia
  REGIME_NORMAL             // Executar apenas em regime normal
  CAMPO_PERSONALIZADO       // Condicao baseada em campo especifico da proposicao
}

// ============================================
// MODELOS DE TRANSPARENCIA PUBLICA
// ============================================

// Enums para Transparencia
enum ModalidadeLicitacao {
  PREGAO_ELETRONICO
  PREGAO_PRESENCIAL
  CONCORRENCIA
  TOMADA_DE_PRECOS
  CONVITE
  CONCURSO
  LEILAO
  DISPENSA
  INEXIGIBILIDADE
}

enum TipoLicitacao {
  MENOR_PRECO
  MELHOR_TECNICA
  TECNICA_E_PRECO
  MAIOR_LANCE
}

enum SituacaoLicitacao {
  EM_ANDAMENTO
  HOMOLOGADA
  ADJUDICADA
  REVOGADA
  ANULADA
  DESERTA
  FRACASSADA
  SUSPENSA
}

enum ModalidadeContrato {
  CONTRATO_ORIGINAL
  ADITIVO
  APOSTILAMENTO
  RESCISAO
}

enum SituacaoContrato {
  VIGENTE
  ENCERRADO
  RESCINDIDO
  SUSPENSO
}

enum SituacaoConvenio {
  EM_EXECUCAO
  CONCLUIDO
  RESCINDIDO
  SUSPENSO
  PRESTACAO_CONTAS
}

enum CategoriaReceita {
  RECEITA_CORRENTE
  RECEITA_CAPITAL
  RECEITA_INTRAORCAMENTARIA
}

enum OrigemReceita {
  TRIBUTARIA
  CONTRIBUICOES
  PATRIMONIAL
  SERVICOS
  TRANSFERENCIAS
  OUTRAS
}

enum SituacaoReceita {
  PREVISTA
  ARRECADADA
  PARCIALMENTE_ARRECADADA
  CANCELADA
}

enum SituacaoDespesa {
  EMPENHADA
  LIQUIDADA
  PAGA
  ANULADA
  PARCIALMENTE_PAGA
}

enum SituacaoServidor {
  ATIVO
  APOSENTADO
  AFASTADO
  CEDIDO
  LICENCIADO
  EXONERADO
  FALECIDO
}

enum VinculoServidor {
  EFETIVO
  COMISSIONADO
  TEMPORARIO
  ESTAGIARIO
  TERCEIRIZADO
}

enum TipoBem {
  MOVEL
  IMOVEL
}

enum SituacaoBem {
  EM_USO
  OCIOSO
  INSERVIVEL
  BAIXADO
  CEDIDO
  EM_MANUTENCAO
}

// Modelo de Licitacao
model Licitacao {
  id                    String             @id @default(cuid())
  numero                String
  ano                   Int
  modalidade            ModalidadeLicitacao
  tipo                  TipoLicitacao      @default(MENOR_PRECO)
  objeto                String             @db.Text
  valorEstimado         Decimal?           @db.Decimal(15, 2)
  dataPublicacao        DateTime?
  dataAbertura          DateTime
  horaAbertura          String?
  dataEntregaPropostas  DateTime?
  horaEntregaPropostas  String?
  situacao              SituacaoLicitacao  @default(EM_ANDAMENTO)
  unidadeGestora        String?
  linkEdital            String?
  linkAta               String?
  arquivo               String?
  observacoes           String?            @db.Text
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  contratos  Contrato[]
  despesas   Despesa[]
  documentos LicitacaoDocumento[]

  @@unique([numero, ano])
  @@index([situacao])
  @@index([modalidade])
  @@index([dataAbertura])
  @@map("licitacoes")
}

model LicitacaoDocumento {
  id           String   @id @default(cuid())
  licitacaoId  String
  titulo       String
  tipo         String?  // edital, ata, anexo, etc
  arquivo      String
  tamanho      String?
  dataUpload   DateTime @default(now())

  licitacao Licitacao @relation(fields: [licitacaoId], references: [id], onDelete: Cascade)

  @@map("licitacoes_documentos")
}

// Modelo de Contrato
model Contrato {
  id                String            @id @default(cuid())
  numero            String
  ano               Int
  modalidade        ModalidadeContrato @default(CONTRATO_ORIGINAL)
  objeto            String            @db.Text
  contratado        String
  cnpjCpf           String
  valorTotal        Decimal           @db.Decimal(15, 2)
  dataAssinatura    DateTime
  vigenciaInicio    DateTime
  vigenciaFim       DateTime
  fiscalContrato    String?
  situacao          SituacaoContrato  @default(VIGENTE)
  licitacaoId       String?
  contratoOrigemId  String?           // Para aditivos, referência ao contrato original
  arquivo           String?
  observacoes       String?           @db.Text
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  licitacao       Licitacao? @relation(fields: [licitacaoId], references: [id], onDelete: SetNull)
  contratoOrigem  Contrato?  @relation("ContratoAditivos", fields: [contratoOrigemId], references: [id], onDelete: SetNull)
  aditivos        Contrato[] @relation("ContratoAditivos")
  despesas        Despesa[]

  @@unique([numero, ano])
  @@index([situacao])
  @@index([contratado])
  @@index([vigenciaFim])
  @@map("contratos")
}

// Modelo de Convenio
model Convenio {
  id                  String           @id @default(cuid())
  numero              String
  ano                 Int
  convenente          String
  cnpjConvenente      String
  orgaoConcedente     String
  objeto              String           @db.Text
  programa            String?
  acao                String?
  valorTotal          Decimal          @db.Decimal(15, 2)
  valorRepasse        Decimal          @db.Decimal(15, 2)
  valorContrapartida  Decimal          @db.Decimal(15, 2) @default(0)
  dataCelebracao      DateTime
  vigenciaInicio      DateTime
  vigenciaFim         DateTime
  responsavelTecnico  String?
  situacao            SituacaoConvenio @default(EM_EXECUCAO)
  fonteRecurso        String?
  arquivo             String?
  observacoes         String?          @db.Text
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  despesas Despesa[]

  @@unique([numero, ano])
  @@index([situacao])
  @@index([convenente])
  @@index([vigenciaFim])
  @@map("convenios")
}

// Modelo de Receita
model Receita {
  id               String          @id @default(cuid())
  numero           String?
  ano              Int
  mes              Int
  data             DateTime
  contribuinte     String?
  cnpjCpf          String?
  unidade          String?
  categoria        CategoriaReceita @default(RECEITA_CORRENTE)
  origem           OrigemReceita   @default(OUTRAS)
  especie          String?
  rubrica          String?
  subrubrica       String?
  alinea           String?
  subalinea        String?
  valorPrevisto    Decimal         @db.Decimal(15, 2) @default(0)
  valorArrecadado  Decimal         @db.Decimal(15, 2) @default(0)
  situacao         SituacaoReceita @default(PREVISTA)
  fonteRecurso     String?
  observacoes      String?         @db.Text
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([ano, mes])
  @@index([categoria])
  @@index([situacao])
  @@map("receitas")
}

// Modelo de Despesa
model Despesa {
  id              String          @id @default(cuid())
  numeroEmpenho   String
  ano             Int
  mes             Int
  data            DateTime
  credor          String
  cnpjCpf         String
  unidade         String?
  elemento        String?
  funcao          String?
  subfuncao       String?
  programa        String?
  acao            String?
  valorEmpenhado  Decimal         @db.Decimal(15, 2)
  valorLiquidado  Decimal         @db.Decimal(15, 2) @default(0)
  valorPago       Decimal         @db.Decimal(15, 2) @default(0)
  situacao        SituacaoDespesa @default(EMPENHADA)
  fonteRecurso    String?
  modalidade      String?
  licitacaoId     String?
  contratoId      String?
  convenioId      String?
  observacoes     String?         @db.Text
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  licitacao Licitacao? @relation(fields: [licitacaoId], references: [id], onDelete: SetNull)
  contrato  Contrato?  @relation(fields: [contratoId], references: [id], onDelete: SetNull)
  convenio  Convenio?  @relation(fields: [convenioId], references: [id], onDelete: SetNull)

  @@unique([numeroEmpenho, ano])
  @@index([ano, mes])
  @@index([credor])
  @@index([situacao])
  @@map("despesas")
}

// Modelo de Servidor
model Servidor {
  id              String          @id @default(cuid())
  nome            String
  cpf             String          @unique
  matricula       String          @unique
  cargo           String
  funcao          String?
  unidade         String?
  lotacao         String?
  vinculo         VinculoServidor @default(EFETIVO)
  dataAdmissao    DateTime
  dataDesligamento DateTime?
  cargaHoraria    Int?            @default(40)
  salarioBruto    Decimal         @db.Decimal(15, 2)
  situacao        SituacaoServidor @default(ATIVO)
  observacoes     String?         @db.Text
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([situacao])
  @@index([vinculo])
  @@index([unidade])
  @@map("servidores")
}

// Modelo de Folha de Pagamento
model FolhaPagamento {
  id                String   @id @default(cuid())
  competencia       String   // Ex: "2025/01"
  mes               Int
  ano               Int
  totalServidores   Int      @default(0)
  totalBruto        Decimal  @db.Decimal(15, 2) @default(0)
  totalDeducoes     Decimal  @db.Decimal(15, 2) @default(0)
  totalLiquido      Decimal  @db.Decimal(15, 2) @default(0)
  dataProcessamento DateTime?
  situacao          String   @default("PROCESSADA")
  arquivo           String?
  observacoes       String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([mes, ano])
  @@index([ano])
  @@map("folhas_pagamento")
}

// Modelo de Bem Patrimonial (Moveis e Imoveis)
model BemPatrimonial {
  id               String       @id @default(cuid())
  tipo             TipoBem
  tombamento       String       @unique
  descricao        String
  especificacao    String?      @db.Text
  dataAquisicao    DateTime
  valorAquisicao   Decimal      @db.Decimal(15, 2)
  valorAtual       Decimal?     @db.Decimal(15, 2)
  localizacao      String?
  responsavel      String?
  situacao         SituacaoBem  @default(EM_USO)
  // Campos especificos para imoveis
  matriculaImovel  String?
  enderecoImovel   String?
  areaImovel       Decimal?     @db.Decimal(15, 2)
  // Comum
  observacoes      String?      @db.Text
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([tipo])
  @@index([situacao])
  @@map("bens_patrimoniais")
}

// ============================================
// SISTEMA DE PARECERES DAS COMISSOES
// ============================================

enum TipoParecer {
  FAVORAVEL
  FAVORAVEL_COM_EMENDAS
  CONTRARIO
  PELA_INCONSTITUCIONALIDADE
  PELA_ILEGALIDADE
  PELA_PREJUDICIALIDADE
  PELA_RETIRADA
}

enum StatusParecer {
  RASCUNHO                 // Relator esta elaborando
  AGUARDANDO_PAUTA         // Concluido, aguardando inclusao em pauta de reuniao
  AGUARDANDO_VOTACAO       // Incluido na pauta, aguardando votacao na comissao
  APROVADO_COMISSAO        // Aprovado pela comissao
  REJEITADO_COMISSAO       // Rejeitado pela comissao (volta ao relator)
  EMITIDO                  // Parecer final emitido
  ARQUIVADO                // Arquivado (materia arquivada)
}

model Parecer {
  id                String        @id @default(cuid())
  // Relacionamentos principais
  proposicaoId      String
  comissaoId        String
  relatorId         String        // Parlamentar designado como relator
  reuniaoId         String?       // Reuniao onde o parecer foi votado (opcional)

  // Dados do parecer
  numero            String?       // Numero do parecer (ex: 001/2026)
  ano               Int
  tipo              TipoParecer
  status            StatusParecer @default(RASCUNHO)

  // Conteudo
  fundamentacao     String        @db.Text   // Texto completo do parecer
  conclusao         String?       @db.Text   // Conclusao/recomendacao
  ementa            String?                  // Resumo do parecer

  // Emendas propostas (se FAVORAVEL_COM_EMENDAS)
  emendasPropostas  String?       @db.Text   // JSON com emendas propostas

  // Datas
  dataDistribuicao  DateTime      // Data em que foi distribuido ao relator
  prazoEmissao      DateTime?     // Prazo para emitir parecer
  dataElaboracao    DateTime?     // Data em que o relator finalizou
  dataVotacao       DateTime?     // Data da votacao na comissao
  dataEmissao       DateTime?     // Data da emissao oficial

  // Votacao na comissao
  votosAFavor       Int           @default(0)
  votosContra       Int           @default(0)
  votosAbstencao    Int           @default(0)

  // Observacoes e historico
  observacoes       String?       @db.Text
  motivoRejeicao    String?       @db.Text   // Se rejeitado pela comissao

  // Arquivo do parecer (PDF anexado)
  arquivoUrl        String?       // URL do arquivo no storage
  arquivoNome       String?       // Nome original do arquivo
  arquivoTamanho    Int?          // Tamanho em bytes

  // Link externo (Google Drive, OneDrive, etc)
  driveUrl          String?       // URL do arquivo em servico externo

  // Controle
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relacionamentos
  proposicao        Proposicao    @relation(fields: [proposicaoId], references: [id], onDelete: Cascade)
  comissao          Comissao      @relation(fields: [comissaoId], references: [id], onDelete: Cascade)
  relator           Parlamentar   @relation("ParecerRelator", fields: [relatorId], references: [id])
  reuniao           ReuniaoComissao? @relation(fields: [reuniaoId], references: [id], onDelete: SetNull)
  votosComissao     VotoParecerComissao[]
  pautaItens        PautaItem[]

  @@unique([proposicaoId, comissaoId]) // Uma proposicao so pode ter um parecer por comissao
  @@index([proposicaoId])
  @@index([comissaoId])
  @@index([relatorId])
  @@index([reuniaoId])
  @@index([status])
  @@index([dataDistribuicao])
  @@map("pareceres")
}

// Registro individual de votos na comissao sobre o parecer
model VotoParecerComissao {
  id            String      @id @default(cuid())
  parecerId     String
  parlamentarId String
  voto          TipoVoto    // SIM (aprova parecer), NAO (rejeita), ABSTENCAO
  dataVoto      DateTime    @default(now())
  observacoes   String?

  parecer       Parecer     @relation(fields: [parecerId], references: [id], onDelete: Cascade)
  parlamentar   Parlamentar @relation("VotoParecerComissao", fields: [parlamentarId], references: [id])

  @@unique([parecerId, parlamentarId]) // Um parlamentar so vota uma vez por parecer
  @@map("votos_parecer_comissao")
}

// ============================================
// SISTEMA DE QUORUM CONFIGURAVEL
// ============================================

enum TipoQuorum {
  MAIORIA_SIMPLES        // Mais SIMs que NAOs dos presentes
  MAIORIA_ABSOLUTA       // Mais de 50% do total de membros
  DOIS_TERCOS            // 2/3 do total de membros
  TRES_QUINTOS           // 3/5 do total de membros
  UNANIMIDADE            // 100% dos presentes
}

enum AplicacaoQuorum {
  INSTALACAO_SESSAO      // Quorum para iniciar sessao
  VOTACAO_SIMPLES        // Votacao de materias simples
  VOTACAO_ABSOLUTA       // PLCs, Regimento Interno
  VOTACAO_QUALIFICADA    // Emendas a Lei Organica, vetos
  VOTACAO_URGENCIA       // Regime de urgencia
  VOTACAO_COMISSAO       // Votacao em comissoes
  DERRUBADA_VETO         // Derrubar veto do Executivo
}

model ConfiguracaoQuorum {
  id                String          @id @default(cuid())

  // Identificacao
  nome              String          // Ex: "Quorum para PLC"
  descricao         String?         @db.Text
  aplicacao         AplicacaoQuorum @unique

  // Tipo de quorum
  tipoQuorum        TipoQuorum      @default(MAIORIA_SIMPLES)

  // Configuracoes personalizadas (para casos especiais)
  percentualMinimo  Float?          // Ex: 66.67 para 2/3
  numeroMinimo      Int?            // Numero absoluto minimo (se aplicavel)

  // Base de calculo
  baseCalculo       String          @default("PRESENTES") // PRESENTES, TOTAL_MEMBROS, TOTAL_MANDATOS

  // Tipos de proposicao que usam este quorum
  tiposProposicao   String?         @db.Text // JSON array com tipos: ["PROJETO_LEI_COMPLEMENTAR", "EMENDA_LEI_ORGANICA"]

  // Configuracoes adicionais
  permitirAbstencao Boolean         @default(true)
  abstencaoContaContra Boolean      @default(false) // Se abstencao conta como voto contra
  requererVotacaoNominal Boolean    @default(false)

  // Mensagens personalizadas
  mensagemAprovacao String?         // Ex: "Aprovado por maioria absoluta"
  mensagemRejeicao  String?         // Ex: "Rejeitado por nao atingir quorum"

  // Controle
  ativo             Boolean         @default(true)
  ordem             Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Multi-tenant
  tenantId          String?
  tenant            Tenant?         @relation(fields: [tenantId], references: [id])

  @@index([aplicacao])
  @@index([ativo])
  @@index([tenantId])
  @@map("configuracoes_quorum")
}

// =============================================================================
// Sistema de Favoritos e Acompanhamento
// =============================================================================

model Favorito {
  id              String          @id @default(cuid())

  // Usuario que favoritou
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Tipo e referencia do item favoritado
  tipoItem        TipoFavorito
  itemId          String          // ID da proposicao, sessao, parlamentar, etc.

  // Configuracoes de notificacao
  notificarMudancas  Boolean      @default(true)
  notificarVotacao   Boolean      @default(true)
  notificarParecer   Boolean      @default(true)

  // Anotacoes pessoais
  anotacao        String?         @db.Text

  // Metadados
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Multi-tenant
  tenantId        String?
  tenant          Tenant?         @relation(fields: [tenantId], references: [id])

  // Indices
  @@unique([userId, tipoItem, itemId])
  @@index([userId])
  @@index([tipoItem])
  @@index([itemId])
  @@index([tenantId])
  @@map("favoritos")
}

enum TipoFavorito {
  PROPOSICAO
  SESSAO
  PARLAMENTAR
  COMISSAO
  PUBLICACAO
}

// =============================================================================
// FASE 2: MÓDULO DE PROTOCOLO ADMINISTRATIVO
// =============================================================================

enum TipoProtocolo {
  ENTRADA
  SAIDA
  INTERNO
}

enum SituacaoProtocolo {
  ABERTO
  EM_TRAMITACAO
  RESPONDIDO
  ARQUIVADO
  DEVOLVIDO
  CANCELADO
}

enum PrioridadeProtocolo {
  BAIXA
  NORMAL
  ALTA
  URGENTE
}

enum TipoRemetente {
  PESSOA_FISICA
  PESSOA_JURIDICA
  ORGAO_PUBLICO
  PARLAMENTAR
  EXECUTIVO
}

model Protocolo {
  id                String              @id @default(cuid())
  numero            Int
  ano               Int
  tipo              TipoProtocolo       @default(ENTRADA)

  // Remetente
  nomeRemetente     String
  cpfCnpjRemetente  String?
  tipoRemetente     TipoRemetente       @default(PESSOA_FISICA)
  enderecoRemetente String?
  telefoneRemetente String?
  emailRemetente    String?

  // Conteúdo
  assunto           String
  descricao         String?             @db.Text
  tipoDocumento     String?             // Ofício, Requerimento, Solicitação, etc.
  numeroDocOrigem   String?             // Número do documento original

  // Controle
  situacao          SituacaoProtocolo   @default(ABERTO)
  prazoResposta     DateTime?
  prioridade        PrioridadeProtocolo @default(NORMAL)
  sigiloso          Boolean             @default(false)

  // Rastreamento
  etiquetaCodigo    String?             @unique // Código de barras/QR

  // Datas
  dataRecebimento   DateTime            @default(now())
  dataResposta      DateTime?

  // Controle
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relacionamentos
  anexos            ProtocoloAnexo[]
  tramitacoes       ProtocoloTramitacao[]

  @@unique([numero, ano])
  @@index([situacao])
  @@index([tipo])
  @@index([dataRecebimento])
  @@index([prioridade])
  @@map("protocolos")
}

model ProtocoloAnexo {
  id           String   @id @default(cuid())
  protocoloId  String
  titulo       String
  arquivo      String
  tamanho      Int?
  tipoMime     String?
  dataUpload   DateTime @default(now())

  protocolo Protocolo @relation(fields: [protocoloId], references: [id], onDelete: Cascade)

  @@index([protocoloId])
  @@map("protocolo_anexos")
}

model ProtocoloTramitacao {
  id              String   @id @default(cuid())
  protocoloId     String
  data            DateTime @default(now())
  unidadeOrigem   String
  unidadeDestino  String
  acao            String   // Encaminhado, Recebido, Devolvido, etc.
  despacho        String?  @db.Text
  usuarioId       String?

  protocolo Protocolo @relation(fields: [protocoloId], references: [id], onDelete: Cascade)

  @@index([protocoloId, data])
  @@map("protocolo_tramitacoes")
}

// =============================================================================
// FASE 4: COMPILAÇÃO DE TEXTOS LEGISLATIVOS (NORMAS JURÍDICAS)
// =============================================================================

enum TipoNormaJuridica {
  LEI_ORDINARIA
  LEI_COMPLEMENTAR
  DECRETO_LEGISLATIVO
  RESOLUCAO
  EMENDA_LEI_ORGANICA
  LEI_ORGANICA
  REGIMENTO_INTERNO
}

enum SituacaoNorma {
  VIGENTE
  REVOGADA
  REVOGADA_PARCIALMENTE
  COM_ALTERACOES
  SUSPENSA
}

model NormaJuridica {
  id              String            @id @default(cuid())
  tipo            TipoNormaJuridica
  numero          Int
  ano             Int
  data            DateTime          // Data de aprovação
  dataPublicacao  DateTime?
  dataVigencia    DateTime?         // Data em que entra em vigor

  // Conteúdo
  ementa          String            @db.Text
  preambulo       String?           @db.Text
  texto           String            @db.Text
  textoCompilado  String?           @db.Text // Texto com todas as alterações incorporadas

  // Situação
  situacao        SituacaoNorma     @default(VIGENTE)

  // Indexação
  assunto         String?
  indexacao       String?           @db.Text // Palavras-chave para busca
  observacao      String?           @db.Text

  // Origem (se veio de proposição)
  proposicaoOrigemId String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relacionamentos
  artigos         ArtigoNorma[]
  versoes         VersaoNorma[]
  alteracoesRecebidas AlteracaoNorma[] @relation("NormaAlterada")
  alteracoesFeitas    AlteracaoNorma[] @relation("NormaAlteradora")

  @@unique([tipo, numero, ano])
  @@index([situacao])
  @@index([tipo])
  @@index([dataPublicacao])
  @@map("normas_juridicas")
}

model ArtigoNorma {
  id            String   @id @default(cuid())
  normaId       String
  numero        String   // "1", "1-A", etc.
  caput         String   @db.Text
  vigente       Boolean  @default(true)
  revogadoPor   String?  // ID da norma que revogou
  alteradoPor   String?  // ID da norma que alterou
  textoOriginal String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  norma      NormaJuridica   @relation(fields: [normaId], references: [id], onDelete: Cascade)
  paragrafos ParagrafoNorma[]

  @@index([normaId])
  @@index([vigente])
  @@map("artigos_norma")
}

enum TipoParagrafoNorma {
  PARAGRAFO_UNICO
  PARAGRAFO
  INCISO
  ALINEA
}

model ParagrafoNorma {
  id        String             @id @default(cuid())
  artigoId  String
  tipo      TipoParagrafoNorma
  numero    String?            // "§1º", "I", "a", etc.
  texto     String             @db.Text
  vigente   Boolean            @default(true)

  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  artigo ArtigoNorma @relation(fields: [artigoId], references: [id], onDelete: Cascade)

  @@index([artigoId])
  @@map("paragrafos_norma")
}

enum TipoAlteracaoNorma {
  ALTERACAO
  REVOGACAO
  REVOGACAO_PARCIAL
  ACRESCIMO
  NOVA_REDACAO
}

model AlteracaoNorma {
  id               String             @id @default(cuid())
  normaAlteradaId  String
  normaAlteradoraId String
  tipoAlteracao    TipoAlteracaoNorma
  artigoAlterado   String?            // Referência ao artigo alterado
  descricao        String?            @db.Text
  dataAlteracao    DateTime

  createdAt        DateTime           @default(now())

  normaAlterada    NormaJuridica @relation("NormaAlterada", fields: [normaAlteradaId], references: [id], onDelete: Cascade)
  normaAlteradora  NormaJuridica @relation("NormaAlteradora", fields: [normaAlteradoraId], references: [id], onDelete: Cascade)

  @@index([normaAlteradaId])
  @@index([normaAlteradoraId])
  @@map("alteracoes_norma")
}

model VersaoNorma {
  id              String   @id @default(cuid())
  normaId         String
  versao          Int
  textoCompleto   String   @db.Text
  motivoAlteracao String?
  dataVersao      DateTime

  createdAt       DateTime @default(now())

  norma NormaJuridica @relation(fields: [normaId], references: [id], onDelete: Cascade)

  @@unique([normaId, versao])
  @@index([normaId])
  @@map("versoes_norma")
}

// =============================================================================
// FASE 5: PARTICIPAÇÃO CIDADÃ EXPANDIDA
// =============================================================================

enum StatusConsultaPublica {
  RASCUNHO
  ABERTA
  ENCERRADA
  EM_ANALISE
  PUBLICADA
}

enum TipoPerguntaConsulta {
  MULTIPLA_ESCOLHA
  ESCOLHA_UNICA
  TEXTO_LIVRE
  ESCALA           // 1-5, 1-10
  SIM_NAO
}

model ConsultaPublica {
  id              String                @id @default(cuid())
  titulo          String
  descricao       String                @db.Text
  proposicaoId    String?               // Se relacionada a uma proposição
  status          StatusConsultaPublica @default(RASCUNHO)

  // Período
  dataInicio      DateTime
  dataFim         DateTime

  // Configuração
  permitirAnonimo Boolean               @default(false)
  requerCadastro  Boolean               @default(true)
  moderacao       Boolean               @default(true) // Moderar respostas antes de publicar

  // Estatísticas
  totalParticipacoes Int               @default(0)

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Relacionamentos
  perguntas       PerguntaConsulta[]
  participacoes   ParticipacaoConsulta[]

  @@index([status])
  @@index([dataInicio, dataFim])
  @@map("consultas_publicas")
}

model PerguntaConsulta {
  id            String               @id @default(cuid())
  consultaId    String
  ordem         Int
  texto         String
  tipo          TipoPerguntaConsulta @default(ESCOLHA_UNICA)
  obrigatoria   Boolean              @default(true)
  opcoes        String?              @db.Text // JSON array de opções

  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  consulta ConsultaPublica    @relation(fields: [consultaId], references: [id], onDelete: Cascade)
  respostas RespostaConsulta[]

  @@index([consultaId, ordem])
  @@map("perguntas_consulta")
}

model ParticipacaoConsulta {
  id          String   @id @default(cuid())
  consultaId  String
  nome        String?
  email       String?
  cpfHash     String?  // Hash do CPF para evitar duplicação
  bairro      String?
  dataParticipacao DateTime @default(now())

  consulta ConsultaPublica @relation(fields: [consultaId], references: [id], onDelete: Cascade)
  respostas RespostaConsulta[]

  @@index([consultaId])
  @@index([cpfHash])
  @@map("participacoes_consulta")
}

model RespostaConsulta {
  id             String   @id @default(cuid())
  participacaoId String
  perguntaId     String
  resposta       String   @db.Text

  createdAt      DateTime @default(now())

  participacao ParticipacaoConsulta @relation(fields: [participacaoId], references: [id], onDelete: Cascade)
  pergunta     PerguntaConsulta     @relation(fields: [perguntaId], references: [id], onDelete: Cascade)

  @@unique([participacaoId, perguntaId])
  @@map("respostas_consulta")
}

enum StatusSugestaoLegislativa {
  PENDENTE
  EM_ANALISE
  ACEITA
  RECUSADA
  CONVERTIDA_PROPOSICAO
}

enum CategoriaSugestao {
  INFRAESTRUTURA
  SAUDE
  EDUCACAO
  SEGURANCA
  MEIO_AMBIENTE
  TRANSPORTE
  CULTURA
  ESPORTE
  ASSISTENCIA_SOCIAL
  ECONOMIA
  OUTROS
}

model SugestaoLegislativa {
  id                String                    @id @default(cuid())

  // Autor
  nome              String
  email             String
  cpfHash           String?                   // Hash do CPF
  bairro            String?
  telefone          String?

  // Conteúdo
  titulo            String
  descricao         String                    @db.Text
  justificativa     String                    @db.Text
  categoria         CategoriaSugestao         @default(OUTROS)

  // Status
  status            StatusSugestaoLegislativa @default(PENDENTE)
  motivoRecusa      String?                   @db.Text
  proposicaoId      String?                   // Se convertida em proposição
  parlamentarResponsavelId String?            // Parlamentar que assumiu

  // Apoios
  totalApoios       Int                       @default(0)

  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt

  // Relacionamentos
  apoios            ApoioSugestao[]

  @@index([status])
  @@index([categoria])
  @@index([totalApoios])
  @@map("sugestoes_legislativas")
}

model ApoioSugestao {
  id         String   @id @default(cuid())
  sugestaoId String
  nome       String
  email      String
  cpfHash    String   // Hash do CPF para evitar duplicação
  createdAt  DateTime @default(now())

  sugestao SugestaoLegislativa @relation(fields: [sugestaoId], references: [id], onDelete: Cascade)

  @@unique([sugestaoId, cpfHash])
  @@index([sugestaoId])
  @@map("apoios_sugestao")
}

// =============================================================================
// FASE 6: ANALYTICS E BUSINESS INTELLIGENCE
// =============================================================================

enum FrequenciaRelatorio {
  DIARIO
  SEMANAL
  QUINZENAL
  MENSAL
  TRIMESTRAL
  SEMESTRAL
  ANUAL
}

enum FormatoRelatorio {
  PDF
  EXCEL
  CSV
  JSON
}

enum TipoRelatorioAgendado {
  PRODUCAO_LEGISLATIVA
  PRESENCA_SESSOES
  VOTACOES
  TRAMITACAO
  COMISSOES
  TRANSPARENCIA
  PERSONALIZADO
}

model RelatorioAgendado {
  id              String               @id @default(cuid())
  nome            String
  descricao       String?
  tipo            TipoRelatorioAgendado @default(PERSONALIZADO)
  filtros         String?              @db.Text // JSON com filtros do relatório

  // Agendamento
  frequencia      FrequenciaRelatorio
  diaSemana       Int?                 // 0-6 para semanal
  diaHora         String?              // "08:00" horário de execução

  // Destino
  destinatarios   String?              @db.Text // JSON array de emails
  formato         FormatoRelatorio     @default(PDF)

  // Controle
  ativo           Boolean              @default(true)
  ultimaExecucao  DateTime?
  proximaExecucao DateTime?

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relacionamentos
  execucoes       ExecucaoRelatorio[]

  @@index([ativo])
  @@index([proximaExecucao])
  @@map("relatorios_agendados")
}

model ExecucaoRelatorio {
  id             String   @id @default(cuid())
  relatorioId    String
  dataExecucao   DateTime @default(now())
  status         String   @default("EXECUTANDO") // EXECUTANDO, CONCLUIDO, ERRO
  arquivoUrl     String?
  erro           String?  @db.Text
  tempoExecucao  Int?     // Em segundos

  relatorio RelatorioAgendado @relation(fields: [relatorioId], references: [id], onDelete: Cascade)

  @@index([relatorioId, dataExecucao])
  @@map("execucoes_relatorio")
}

model DashboardPersonalizado {
  id        String   @id @default(cuid())
  userId    String
  nome      String
  widgets   String   @db.Text // JSON com configuração dos widgets
  layout    String?  @db.Text // JSON com layout do dashboard
  publico   Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([publico])
  @@map("dashboards_personalizados")
}
